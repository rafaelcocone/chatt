<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Servidor de streaming</title>
    <link rel="stylesheet" href="/style.css" media="screen" charset="utf-8" />
  </head>
  <body>
    <h1>Servidor de streaming</h1>
    <p>Tranmicion de tiempo real</p>
    <button id="broadcast" class="play">Broadcast</button>

    <video id="video"></video>
    <canvas id="canvas" width="1200" height="720"></canvas>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js" integrity="sha256-bQmrZe4yPnQrLTY+1gYylfNMBuGfnT/HKsCGX+9Xuqo=" crossorigin="anonymous"></script>
    <script>
      
      (function (d,io,na,w){
        'use strict'

        var peerConnection = window.RTCPeerConnection ||
                     window.mozRTCPeerConnection ||
                     window.webkitRTCPeerConnection ||
                     window.msRTCPeerConnection;

        var sessionDescription = window.RTCSessionDescription ||
                                window.mozRTCSessionDescription ||
                                window.webkitRTCSessionDescription ||
                                window.msRTCSessionDescription;

        navigator.getUserMedia  = navigator.getUserMedia ||
                                navigator.webkitGetUserMedia ||
                                navigator.mozGetUserMedia ||
                                navigator.msGetUserMedia;

        //var socket = io.connect('http://localhost:5000');

        var pc = new peerConnection({ iceServers: [{ url: "turn:mrbisne.com",
            username: 'mrtest',
            credential: 'mrpass'
            }]
        });

        function error (err) {
        console.warn(err);
        }

        var answersFrom = {};
        var $urlIO =  window.location.hostname == "localhost" ? 'https://localhost:3002' : 'https://mrbisne.com:3002' ;
        var socket        = io($urlIO);

        navigator.getUserMedia({ audio: true }, function (stream) {
            pc.addStream(stream);
        }, error);

        function createOffer () {
            pc.createOffer(function(offer) {
                pc.setLocalDescription(new sessionDescription(offer), function () {
                    socket.emit('make-offer', {
                        offer: offer
                    });
                }, error);
            }, error);
        }

        socket.on('answer-made', function (data) {
            pc.setRemoteDescription(new sessionDescription(data.answer), function () {
                if (!answersFrom[data.socket]) {
                    createOffer(data.socket);
                    answersFrom[data.socket] = true;
                }
            }, error);
        });

        var btn = document.getElementById('broadcast');
        btn.addEventListener('click', function () {
            if (btn.getAttribute('class') === 'stop') {
                btn.setAttribute('class', 'play');
                btn.innerHTML = 'Broadcast';
            } else {
                btn.setAttribute('class', 'stop');
                btn.innerHTML = 'Broadcasting...';
                createOffer();
            }
        });

        /******************************************/

        var //io          = io('http://localhost:3002//'),
            startCamera = false,
            mediaSource = new MediaSource(),
            //video = d.createElement('video'),
            video = d.querySelector('video'),
         //   video = d.getElementById('video'),
            canvas      = d.querySelector('#canvas'),
            contexto    = canvas.getContext('2d'),
            mediaStream = new MediaStream(),
            audioContext = new AudioContext(),
            constraints = { audio: true, video: {
                                  width: { min: 480, ideal: 720, max: 1024 },
                                  height: { min: 360, ideal: 560, max: 720 },
                                  frameRate: { ideal: 10, max: 15 } 
                                } }
          
        na.getMedia =   (
          na.getUserMedia ||
          na.webkitGetMedia ||
          na.mozGetUserMedia ||
          na.msGetUserMedia  
        )
       // console.log( na.mediaDevices);
        na.mediaDevices.getUserMedia(constraints)
          .then(function(mediaStream) {
            video.srcObject = mediaStream
            startCamera = true
            video.onloadedmetadata = function(e) {
              video.play();
            };
           
            
          })
          .catch(function(err) { console.log(err.name + ": " + err.message); });

          w.playVideo = (function(cb){
            return  w.requestAnimationFrame ||
                    w.webkitCancelAnimationFrame ||
                    w.mozRequestAnimationFrame ||
                    w.msRequestAnimationFrame ||
                    function (cb){
                      w.setTimeout(cb,1000/100)
                    }
          })()

          function streamVideo(contexto,canvas, video){
            var outputStream = canvas.toDataURL('image/webp',.2)
            contexto.drawImage(video,0,0)
            if(startCamera)
                socket.emit('streaming',outputStream )
            playVideo(function(){
              streamVideo(contexto, canvas, video)
            })
          }
          w.addEventListener('load', function(){
            video.autoplay = true
            video.style.display = 'none'
            streamVideo(contexto, canvas, video)
          })

      })(document,io,navigator, window)
    </script>

  </body>
</html>