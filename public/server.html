<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Servidor de streaming</title>
    <link rel="stylesheet" href="/style.css" media="screen" charset="utf-8" />
  </head>
  <body>
    <h1>Servidor de streaming</h1>
    <p>Tranmicion de tiempo real</p>
    <button id="broadcast" class="play">Broadcast</button>

    <div class="container">
      <video class="video-large" autoplay></video>
      <div class="users-container" id="users-container">
          <h4>Users</h4>
          <div id="users"></div>
      </div>
    </div>
    <style>

        html, body {
            padding: 0px;
            margin: 0px;
        }

        video {
            background: #CCC;
        }

        .container {
            width: 100%;
        }

        .video-large {
            width: 75%;
            float: left;
        }

        .users-container {
            width: 21%;
            float: left;
            padding: 2%;
            position: relative;
        }

        .video-small {
            margin-top: 20px;
            width: 100%;
        }

        #users div {
            color: red;
            text-decoration: underline;
            cursor: pointer;
        }

        #users .active {
            color: #000;
            cursor: default;
        }


        button {
            font-size: 2em;
            border: 0px;
            color: #FFF;
        }

        button.play {
            background: green;
        }

        button.stop {
            background: red;
        }

        button.muted {
            background: #CCC;
        }



    </style>


    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js" integrity="sha256-bQmrZe4yPnQrLTY+1gYylfNMBuGfnT/HKsCGX+9Xuqo=" crossorigin="anonymous"></script>
    <script>
      
      (function (d,io,na,w){
        'use strict'

        var peerConnection = window.RTCPeerConnection ||
                     window.mozRTCPeerConnection ||
                     window.webkitRTCPeerConnection ||
                     window.msRTCPeerConnection;

        var sessionDescription = window.RTCSessionDescription ||
                                window.mozRTCSessionDescription ||
                                window.webkitRTCSessionDescription ||
                                window.msRTCSessionDescription;

        navigator.getUserMedia  = navigator.getUserMedia ||
                                navigator.webkitGetUserMedia ||
                                navigator.mozGetUserMedia ||
                                navigator.msGetUserMedia;

        //var socket = io.connect('http://localhost:5000');

        var pc = new peerConnection({ iceServers: [{ url: "turn:mrbisne.com",
            username: 'mrtest',
            credential: 'mrpass'
            }]
        });

        function error (err) {
        console.warn(err);
        }

        var answersFrom = {}, offer;
        var $urlIO =  window.location.hostname == "localhost" ? 'https://localhost:3002' : 'https://mrbisne.com:3002' ;
        var socket        = io($urlIO);



        /*

        navigator.getUserMedia({ audio: true }, function (stream) {
            pc.addStream(stream);
        }, error);

        function createOffer () {
            pc.createOffer(function(offer) {
                pc.setLocalDescription(new sessionDescription(offer), function () {
                    socket.emit('make-offer', {
                        offer: offer
                    });
                }, error);
            }, error);
        }

        socket.on('answer-made', function (data) {
            pc.setRemoteDescription(new sessionDescription(data.answer), function () {
                if (!answersFrom[data.socket]) {
                    createOffer(data.socket);
                    answersFrom[data.socket] = true;
                }
            }, error);
        });

        var btn = document.getElementById('broadcast');
        btn.addEventListener('click', function () {
            if (btn.getAttribute('class') === 'stop') {
                btn.setAttribute('class', 'play');
                btn.innerHTML = 'Broadcast';
            } else {
                btn.setAttribute('class', 'stop');
                btn.innerHTML = 'Broadcasting...';
                createOffer();
            }
        });

        ******************************************/

        pc.onaddstream = function (obj) {
          var vid = document.createElement('video');
          vid.setAttribute('class', 'video-small');
          vid.setAttribute('autoplay', 'autoplay');
          vid.setAttribute('id', 'video-small');
          document.getElementById('users-container').appendChild(vid);
          //vid.src = window.URL.createObjectURL(obj.stream);
          vid.srcObject = obj.stream;
      }

      navigator.getUserMedia({video: true}, function (stream) {
          var video = document.querySelector('video');
          video.srcObject = stream;
        // video.src = window.URL.createObjectURL(stream);
          pc.addStream(stream);
      }, error);

      function error (err) {
          console.warn('Error', err);
      }

      function createOffer (id) {
          pc.createOffer(function(offer) {
              pc.setLocalDescription(new sessionDescription(offer), function () {
                  socket.emit('make-offer', {
                      offer: offer,
                      to: id
                  });
              }, error);
          }, error);
      }

      socket.on('answer-made', function (data) {
          pc.setRemoteDescription(new sessionDescription(data.answer), function () {
              document.getElementById(data.socket).setAttribute('class', 'active');
              if (!answersFrom[data.socket]) {
                  createOffer(data.socket);
                  answersFrom[data.socket] = true;
              }
          }, error);
      });

      socket.on('offer-made', function (data) {
          offer = data.offer;

          pc.setRemoteDescription(new sessionDescription(data.offer), function () {
              pc.createAnswer(function (answer) {
                pc.setLocalDescription(new sessionDescription(answer), function () {
                    socket.emit('make-answer', {
                        answer: answer,
                        to: data.socket
                    });
                }, error);
              }, error);
          }, error);
      });

      socket.on('add-users', function (data) {
          for (var i = 0; i < data.users.length; i++) {
              var el = document.createElement('div'),
                  id = data.users[i];

              el.setAttribute('id', id);
              el.innerHTML = id;
              el.addEventListener('click', function () {
                  createOffer(id);
              });
              document.getElementById('users').appendChild(el);
          }
      });

      socket.on('remove-user', function (id) {
          var div = document.getElementById(id);
          document.getElementById('users').removeChild(div);
      });

      })(document,io,navigator, window)
    </script>

  </body>
</html>